---
name: markdown-heading-numbering
description: Add hierarchical numeric prefixes to markdown section headings in project documentation. Use when working with markdown files and the user wants numbered section titles like 1., 1.1, 1.1.1 to match the heading hierarchy.
---

# Markdown Heading Numbering

## Instructions

When this skill is active, help the user **automatically add or update hierarchical numeric prefixes** for markdown section标题（如 `##`, `###`, `####`），并且：

- **不为一级标题 `#` 添加任何数字前缀**；
- 从二级标题 `##` 开始作为数字层级的第 1 级（即 `1`），三级标题 `###` 作为 `1.1`，依此类推。

形成类似：

- `1 总体设计`
- `1.1 模块划分`
- `1.1.1 数据流`

的层次化数字导引符。

### 适用场景

使用本 skill 当：

- 用户提到“给 markdown 标题自动编号”“添加层次化数字导引符”“1. / 1.1 / 1.1.1 这样的标题编号”等需求时。
- 用户希望对某个 `.md` 文档的所有 section 标题进行统一重排、重新编号。
- 用户想让 Cursor 中的 “Auto markdown sections” 更易读，通过在标题文本里加入编号。

### 目标范围

默认只对 **用户指定的 markdown 文件**（或当前正在讨论的单个 `.md` 文件）进行处理，而不是整个仓库。

如果用户没有明确说要批量处理多个文件：

- 假设只处理当前提到的那一个文档；
- 如果用户明确要求批量操作，再按用户说明的范围（目录、文件列表）扩展。

### 总体流程

1. **读取目标文件**
   - 使用 `Read` 工具加载用户指定的 `.md` 文件的完整内容。
   - 记录原始内容，以便对比和回滚（如果需要）。

2. **解析并扫描标题**
   - 仅在**普通 markdown 文本区**中查找标题，排除以下区域：
     - YAML frontmatter（最开头 `---` 到下一段 `---` 之间）。
     - fenced code block（介于 ```、~~~ 等代码块标记之间）。
   - 识别标题行的基本规则：
     - 行首以 1–6 个 `#` 开头；
     - 后面至少跟一个空格，例如：`## 标题文本`。

3. **维护层级计数器（从二级标题开始）**
   - 使用一个长度为 5 的数组（或等价逻辑）来记录 **二级到六级** 标题的计数，例如：
     - `levelCounters = [0, 0, 0, 0, 0]` 代表 `##` 到 `######`。
   - 遇到标题行时区分处理：
     - 如果是 **一级标题 `#`**：
       - **不添加编号**，也**不修改计数器**；
       - 原样保留其文本内容（只会处理其中的 `{#nonumber}` / `<!-- nonumber -->` 控制标记，见后文）。
     - 如果是 **二级及以上标题（`##`–`######`）**：
       1. 计算标题级别 `level = number_of_hashes`。
       2. 映射到计数器索引：`idx = level - 2`（即 `## → idx 0`，`### → idx 1`）。
       3. 将 `levelCounters[idx] += 1`。
       4. 将所有 **更深层级** 的计数清零：`for i in range(idx + 1, 5): levelCounters[i] = 0`。
       5. 当前标题的数字前缀为：从 `levelCounters[0]` 到 `levelCounters[idx]` 中**非零部分**，用 `.` 连接，例如：
          - 第一节：`[1,0,0,...]` → `1`
          - 第二小节：`[1,2,0,...]` → `1.2`
          - 更小小节：`[1,2,3,0,...]` → `1.2.3`

4. **处理已有前缀与排除标记**

在更新标题文本前，先处理以下情况：

- **去掉已有的数字前缀**  
  - 如果标题文本部分以 `数字[.数字...]+空格` 形式开头，例如：
    - `1 总体设计`
    - `1.2 模块划分`
    - `2.3.1 数据流`
  - 则先移除这段旧前缀，仅保留后面的纯标题文本。

- **跳过不需要编号的标题**（可选，按需支持）  
  - 如果标题行中包含以下任一标记：
    - `{#nonumber}`
    - `<!-- nonumber -->`
  - 则**不为该标题添加数字前缀**，并在最终输出中**移除这些控制标记**以保持标题干净。

5. **生成新的标题行**

- 对于 **一级标题 `#`**：
  - 不生成数字前缀；
  - 仅在需要时去除 `{#nonumber}` / `<!-- nonumber -->` 控制标记；
  - 保持标题文本本身不变。

- 对于 **需要编号的二级及以上标题**：
  1. 保留原始的 `#` 数量与后面的单个空格。
  2. 按计算出的编号构造前缀，例如：`1.2.3`。
  3. 去除已有数字前缀后得到的“纯文本标题”为 `titleText`。
  4. 将标题更新为：
     - `#{levelHashes} {numberPrefix} {titleText}`
     - 例如：`## 1.2 模块划分`
  5. 保留标题中的其它内容（例如 emoji、内联代码等），只要不在被剥离的旧前缀内部即可。

6. **保持非标题内容不变**

- 非标题行（包括段落、列表、表格等）一律原样保留。
- fenced code block 内部的任何内容都**不改动**，即使里面有 `#` 开头的行。
- YAML frontmatter 内不做任何修改。

7. **写回文件**

完成全部标题处理后：

- 使用 `ApplyPatch` 工具更新原始 `.md` 文件内容；
- 确保 patch 仅修改真正改变了的行，避免不必要的空格或行结尾变动。

8. **与用户确认**

在完成自动编号后，用简短总结说明：

- 哪个文件已更新；
- 标题编号的大致样式（例如“使用 1 / 1.1 / 1.1.1 样式”）；
- 是否保留了特殊不编号标题（如带 `{#nonumber}` 标记的）。

如用户需要，可展示一个**代表性的小片段**，而不是整个文档。

## Examples

### 示例：简单三层结构（从二级标题开始编号）

原始 markdown：

```markdown
# 总体设计

## 模块划分

### 数据流
```

应用本 skill 后：

```markdown
# 总体设计

## 1 模块划分

### 1.1 数据流
```

### 示例：已有前缀 & 跳过编号

原始 markdown：

```markdown
# 旧的总标题

## 1 旧的小节

## 不编号的小节 {#nonumber}

### 1.1 旧的小小节
```

应用本 skill 后：

```markdown
# 旧的总标题

## 1 新的小节

## 不编号的小节

### 1.1 新的小小节
```

说明：

- 第二级及以下标题的旧数字前缀被替换为新的层级编号；
- 一级标题始终不添加数字前缀；
- 带 `{#nonumber}` 的标题被完全保留文本、去掉控制标记，但不添加数字前缀。

